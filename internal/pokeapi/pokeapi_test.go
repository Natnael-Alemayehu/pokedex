package pokeapi

import (
	"encoding/json"
	"fmt"
	"net/http"
	"testing"
	"time"

	"github.com/natnael-alemayehu/pokedex/internal/pokecache"
)

func TestAddGet(t *testing.T) {
	var pageurl = "https://pokeapi.co/api/v2/location-area?limit=20&offset=20"
	cases := []struct {
		pageURL *string
		val     []byte
	}{
		{
			pageURL: nil,
			val:     []byte(`{"count":1089,"next":"https://pokeapi.co/api/v2/location-area?offset=20&limit=20","previous":null,"results":[{"name":"canalave-city-area","url":"https://pokeapi.co/api/v2/location-area/1/"},{"name":"eterna-city-area","url":"https://pokeapi.co/api/v2/location-area/2/"},{"name":"pastoria-city-area","url":"https://pokeapi.co/api/v2/location-area/3/"},{"name":"sunyshore-city-area","url":"https://pokeapi.co/api/v2/location-area/4/"},{"name":"sinnoh-pokemon-league-area","url":"https://pokeapi.co/api/v2/location-area/5/"},{"name":"oreburgh-mine-1f","url":"https://pokeapi.co/api/v2/location-area/6/"},{"name":"oreburgh-mine-b1f","url":"https://pokeapi.co/api/v2/location-area/7/"},{"name":"valley-windworks-area","url":"https://pokeapi.co/api/v2/location-area/8/"},{"name":"eterna-forest-area","url":"https://pokeapi.co/api/v2/location-area/9/"},{"name":"fuego-ironworks-area","url":"https://pokeapi.co/api/v2/location-area/10/"},{"name":"mt-coronet-1f-route-207","url":"https://pokeapi.co/api/v2/location-area/11/"},{"name":"mt-coronet-2f","url":"https://pokeapi.co/api/v2/location-area/12/"},{"name":"mt-coronet-3f","url":"https://pokeapi.co/api/v2/location-area/13/"},{"name":"mt-coronet-exterior-snowfall","url":"https://pokeapi.co/api/v2/location-area/14/"},{"name":"mt-coronet-exterior-blizzard","url":"https://pokeapi.co/api/v2/location-area/15/"},{"name":"mt-coronet-4f","url":"https://pokeapi.co/api/v2/location-area/16/"},{"name":"mt-coronet-4f-small-room","url":"https://pokeapi.co/api/v2/location-area/17/"},{"name":"mt-coronet-5f","url":"https://pokeapi.co/api/v2/location-area/18/"},{"name":"mt-coronet-6f","url":"https://pokeapi.co/api/v2/location-area/19/"},{"name":"mt-coronet-1f-from-exterior","url":"https://pokeapi.co/api/v2/location-area/20/"}]}`),
		},
		{
			pageURL: &pageurl,
			val:     []byte(`{"count":1089,"next":"https://pokeapi.co/api/v2/location-area?offset=40&limit=20","previous":"https://pokeapi.co/api/v2/location-area?offset=0&limit=20","results":[{"name":"mt-coronet-1f-route-216","url":"https://pokeapi.co/api/v2/location-area/21/"},{"name":"mt-coronet-1f-route-211","url":"https://pokeapi.co/api/v2/location-area/22/"},{"name":"mt-coronet-b1f","url":"https://pokeapi.co/api/v2/location-area/23/"},{"name":"great-marsh-area-1","url":"https://pokeapi.co/api/v2/location-area/24/"},{"name":"great-marsh-area-2","url":"https://pokeapi.co/api/v2/location-area/25/"},{"name":"great-marsh-area-3","url":"https://pokeapi.co/api/v2/location-area/26/"},{"name":"great-marsh-area-4","url":"https://pokeapi.co/api/v2/location-area/27/"},{"name":"great-marsh-area-5","url":"https://pokeapi.co/api/v2/location-area/28/"},{"name":"great-marsh-area-6","url":"https://pokeapi.co/api/v2/location-area/29/"},{"name":"solaceon-ruins-2f","url":"https://pokeapi.co/api/v2/location-area/30/"},{"name":"solaceon-ruins-1f","url":"https://pokeapi.co/api/v2/location-area/31/"},{"name":"solaceon-ruins-b1f-a","url":"https://pokeapi.co/api/v2/location-area/32/"},{"name":"solaceon-ruins-b1f-b","url":"https://pokeapi.co/api/v2/location-area/33/"},{"name":"solaceon-ruins-b1f-c","url":"https://pokeapi.co/api/v2/location-area/34/"},{"name":"solaceon-ruins-b2f-a","url":"https://pokeapi.co/api/v2/location-area/35/"},{"name":"solaceon-ruins-b2f-b","url":"https://pokeapi.co/api/v2/location-area/36/"},{"name":"solaceon-ruins-b2f-c","url":"https://pokeapi.co/api/v2/location-area/37/"},{"name":"solaceon-ruins-b3f-a","url":"https://pokeapi.co/api/v2/location-area/38/"},{"name":"solaceon-ruins-b3f-b","url":"https://pokeapi.co/api/v2/location-area/39/"},{"name":"solaceon-ruins-b3f-c","url":"https://pokeapi.co/api/v2/location-area/40/"}]}`),
		},
	}

	for i, c := range cases {
		t.Run(fmt.Sprintf("Test case %v", i), func(t *testing.T) {
			client := Client{
				cache:      pokecache.NewCache(5 * time.Minute),
				httpClient: *http.DefaultClient,
			}
			location, err := client.ListLocations(c.pageURL)
			if err != nil {
				t.Errorf("expected to find key")
				return
			}

			locationsResp := RespShallowLocations{}
			if err = json.Unmarshal(c.val, &locationsResp); err != nil {
				t.Errorf("expected")
			}
			if locationsResp.Count != location.Count {
				t.Errorf("expected to find value")
				return
			}
		})
	}
}

func TestListPokemonInLocation(t *testing.T) {
	var areaName = []string{"pastoria-city-area"}
	cases := []struct {
		pageURL      *string
		locationArea []string
		val          []byte
	}{
		{
			locationArea: areaName,
			val:          []byte(`{"encounter_method_rates":[{"encounter_method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"version_details":[{"rate":25,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"rate":25,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"rate":25,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"encounter_method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"version_details":[{"rate":50,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"rate":50,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"rate":50,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"encounter_method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"version_details":[{"rate":75,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"rate":75,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"rate":75,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"encounter_method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"version_details":[{"rate":10,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"rate":10,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"rate":10,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]}],"game_index":3,"id":3,"location":{"name":"pastoria-city","url":"https://pokeapi.co/api/v2/location/3/"},"name":"pastoria-city-area","names":[{"language":{"name":"en","url":"https://pokeapi.co/api/v2/language/9/"},"name":"Pastoria City"},{"language":{"name":"de","url":"https://pokeapi.co/api/v2/language/6/"},"name":"Weideburg"},{"language":{"name":"fr","url":"https://pokeapi.co/api/v2/language/5/"},"name":"Verchamps"}],"pokemon_encounters":[{"pokemon":{"name":"tentacool","url":"https://pokeapi.co/api/v2/pokemon/72/"},"version_details":[{"encounter_details":[{"chance":60,"condition_values":[],"max_level":30,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":60,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"encounter_details":[{"chance":60,"condition_values":[],"max_level":30,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":60,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"encounter_details":[{"chance":60,"condition_values":[],"max_level":30,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":60,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"pokemon":{"name":"tentacruel","url":"https://pokeapi.co/api/v2/pokemon/73/"},"version_details":[{"encounter_details":[{"chance":5,"condition_values":[],"max_level":40,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":5,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"encounter_details":[{"chance":5,"condition_values":[],"max_level":40,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":5,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"encounter_details":[{"chance":5,"condition_values":[],"max_level":40,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":5,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"pokemon":{"name":"magikarp","url":"https://pokeapi.co/api/v2/pokemon/129/"},"version_details":[{"encounter_details":[{"chance":60,"condition_values":[],"max_level":6,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":4},{"chance":30,"condition_values":[],"max_level":7,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":3},{"chance":5,"condition_values":[],"max_level":10,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":5},{"chance":4,"condition_values":[],"max_level":10,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":5},{"chance":1,"condition_values":[],"max_level":10,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":5},{"chance":40,"condition_values":[],"max_level":20,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":15},{"chance":15,"condition_values":[],"max_level":25,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":10}],"max_chance":155,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"encounter_details":[{"chance":60,"condition_values":[],"max_level":6,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":4},{"chance":30,"condition_values":[],"max_level":7,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":3},{"chance":5,"condition_values":[],"max_level":10,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":5},{"chance":4,"condition_values":[],"max_level":10,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":5},{"chance":1,"condition_values":[],"max_level":10,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":5},{"chance":40,"condition_values":[],"max_level":20,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":15},{"chance":15,"condition_values":[],"max_level":25,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":10}],"max_chance":155,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"encounter_details":[{"chance":60,"condition_values":[],"max_level":6,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":4},{"chance":30,"condition_values":[],"max_level":7,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":3},{"chance":5,"condition_values":[],"max_level":10,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":5},{"chance":4,"condition_values":[],"max_level":10,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":5},{"chance":1,"condition_values":[],"max_level":15,"method":{"name":"old-rod","url":"https://pokeapi.co/api/v2/encounter-method/2/"},"min_level":5},{"chance":40,"condition_values":[],"max_level":20,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":15},{"chance":15,"condition_values":[],"max_level":25,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":10}],"max_chance":155,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"pokemon":{"name":"gyarados","url":"https://pokeapi.co/api/v2/pokemon/130/"},"version_details":[{"encounter_details":[{"chance":40,"condition_values":[],"max_level":40,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":30},{"chance":15,"condition_values":[],"max_level":55,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":40}],"max_chance":55,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"encounter_details":[{"chance":40,"condition_values":[],"max_level":40,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":30},{"chance":15,"condition_values":[],"max_level":55,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":40}],"max_chance":55,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"encounter_details":[{"chance":40,"condition_values":[],"max_level":40,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":30},{"chance":15,"condition_values":[],"max_level":55,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":40}],"max_chance":55,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"pokemon":{"name":"remoraid","url":"https://pokeapi.co/api/v2/pokemon/223/"},"version_details":[{"encounter_details":[{"chance":40,"condition_values":[],"max_level":20,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":15},{"chance":4,"condition_values":[],"max_level":25,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":10},{"chance":1,"condition_values":[],"max_level":25,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":10}],"max_chance":45,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"encounter_details":[{"chance":40,"condition_values":[],"max_level":20,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":15},{"chance":4,"condition_values":[],"max_level":25,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":10},{"chance":1,"condition_values":[],"max_level":25,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":10}],"max_chance":45,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"encounter_details":[{"chance":40,"condition_values":[],"max_level":20,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":15},{"chance":4,"condition_values":[],"max_level":25,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":10},{"chance":1,"condition_values":[],"max_level":25,"method":{"name":"good-rod","url":"https://pokeapi.co/api/v2/encounter-method/3/"},"min_level":10}],"max_chance":45,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"pokemon":{"name":"octillery","url":"https://pokeapi.co/api/v2/pokemon/224/"},"version_details":[{"encounter_details":[{"chance":40,"condition_values":[],"max_level":40,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":30},{"chance":4,"condition_values":[],"max_level":50,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":20},{"chance":1,"condition_values":[],"max_level":50,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":20}],"max_chance":45,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"encounter_details":[{"chance":40,"condition_values":[],"max_level":40,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":30},{"chance":4,"condition_values":[],"max_level":50,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":20},{"chance":1,"condition_values":[],"max_level":50,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":20}],"max_chance":45,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"encounter_details":[{"chance":40,"condition_values":[],"max_level":40,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":30},{"chance":4,"condition_values":[],"max_level":55,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":40},{"chance":1,"condition_values":[],"max_level":55,"method":{"name":"super-rod","url":"https://pokeapi.co/api/v2/encounter-method/4/"},"min_level":40}],"max_chance":45,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"pokemon":{"name":"wingull","url":"https://pokeapi.co/api/v2/pokemon/278/"},"version_details":[{"encounter_details":[{"chance":30,"condition_values":[],"max_level":30,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":30,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"encounter_details":[{"chance":30,"condition_values":[],"max_level":30,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":30,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}},{"encounter_details":[{"chance":4,"condition_values":[],"max_level":30,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":4,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"pokemon":{"name":"pelipper","url":"https://pokeapi.co/api/v2/pokemon/279/"},"version_details":[{"encounter_details":[{"chance":4,"condition_values":[],"max_level":40,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20},{"chance":1,"condition_values":[],"max_level":40,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":5,"version":{"name":"diamond","url":"https://pokeapi.co/api/v2/version/12/"}},{"encounter_details":[{"chance":4,"condition_values":[],"max_level":40,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20},{"chance":1,"condition_values":[],"max_level":40,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":5,"version":{"name":"pearl","url":"https://pokeapi.co/api/v2/version/13/"}}]},{"pokemon":{"name":"shellos","url":"https://pokeapi.co/api/v2/pokemon/422/"},"version_details":[{"encounter_details":[{"chance":30,"condition_values":[],"max_level":30,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":30,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]},{"pokemon":{"name":"gastrodon","url":"https://pokeapi.co/api/v2/pokemon/423/"},"version_details":[{"encounter_details":[{"chance":1,"condition_values":[],"max_level":40,"method":{"name":"surf","url":"https://pokeapi.co/api/v2/encounter-method/5/"},"min_level":20}],"max_chance":1,"version":{"name":"platinum","url":"https://pokeapi.co/api/v2/version/14/"}}]}]}`),
		},
	}

	for i, c := range cases {
		t.Run(fmt.Sprintf("Test case %v", i), func(t *testing.T) {
			client := Client{
				cache:      pokecache.NewCache(5 * time.Minute),
				httpClient: *http.DefaultClient,
			}
			got, err := client.ListPokemonInLocation(c.locationArea...)
			if err != nil {
				t.Errorf("expected to find key. The err: %v", err)
				t.Fail()
			}

			expects := RespLolcationPokemon{}
			if err = json.Unmarshal(c.val, &expects); err != nil {
				t.Errorf("unmarshal error: %v", err)
				t.Fail()
			}

			if expects.Name != got.Name {
				t.Errorf("Name mismatch : Expected: %v - Got: %v", expects.Name, got.Name)
				t.Fail()
			}
		})
	}
}
